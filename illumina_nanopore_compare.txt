
setwd("C:/Users/jacqu/Documents/University of Calgary/PostDoc/Atlantic Condor 2021/UofC_Analysis/Seaquencing/16S_Nanopore/fastq_pass_combined")
asv = read.csv("../../Illumina_reads/seaquencing_ASVseq_taxa.csv")

library(reshape2)
library(tidyverse)
asvm = melt(asv, id = c("ASVID", "Kingdom", "Phylum", "Class", "Order", "Family", "Genus"))


#library(data.table)
library(splitstackshape)

asvm0 = asvm %>% filter(value != 0)

#error repeating on value column didn't work
#asvm2 = expandRows(asvm0, asvm0$value)
#repeating on 9th column (which is value column did for some reason)
asvm2 = expandRows(asvm0, count = 9)


asvm_split = split(asvm2, asvm2$variable)



#to apply to all elements of asvm list
fun = function(i){
    sub = sample(1:nrow(i), 1000, replace=FALSE)
    x = i[sub,]}

asvm_sub = lapply(asvm_split, fun)

#apply phyla summary and abundance
fun2 = function(i){
    phy = i %>% filter(Kingdom == "Bacteria") %>% group_by(Phylum) %>% summarise(n = n()) %>% mutate(abund = n/(colSums(as.matrix(n)))*100) %>% select(-n)
    }
phylum_sum = lapply(asvm_sub, fun2)    

tax_df = phylum_sum %>% reduce(full_join, by='Phylum')
colnames(tax_df) = c("Phylum", names(phylum_sum))





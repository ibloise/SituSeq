# Open powershell and type 'wsl' 

#change directory
cd My\ Documents/University\ of\ Calgary/PostDoc/Atlantic\ Condor\ 2021/UofC_Analysis/Seaquencing/16S_Nanopore/fastq_pass/
#concatenate files 
for i in barcode*; do echo $i; cat $i/*.fastq.gz > ${i}_cat.fastq.gz;done

#unzip files - don't know if this is necessary
for i in *.fastq.gz; do gunzip $i; done

#in R
setwd("~/University of Calgary/PostDoc/Atlantic Condor 2021/UofC_Analysis/Seaquencing/16S_Nanopore/fastq_pass")
library(dada2)
library(tidyverse)

#save path to object
path = getwd()

#Forward and fastq filenames have format: 
#barcode01_cat.fastq 
fnFs = sort(list.files(path, pattern="_cat.fastq.gz", full.names = TRUE))

#Extract sample names, assuming filenames have format: #samplename_XXX.fastq.gz
sample.names = sapply(strsplit(basename(fnFs), "_"), `[`, 1)


#filter and trim reads- create new paths for new files 
filtFs <- file.path(path, "filtered", paste0(sample.names, "_filt.fastq.gz"))
names(filtFs) = sample.names




#filter and trim command - compress true or false?
out = filterAndTrim(fnFs, filtFs, trimLeft = 100, trimRight = 100, maxLen = 1850, minLen = 1350,  truncQ = 0, compress = FALSE)
#see how many reads were lost
head(out) 

#can see distribution of sequence read lengths: 
table(nchar(getSequences('filtered/barcode01_filt.fastq.gz')))
plot(table(nchar(getSequences('filtered/barcode01_filt.fastq.gz'))))

#for loop for getting sequences and assigning taxonomy? 
for (fastq in filtFs) {
print(fastq)
seqs = getSequences(fastq)
sub = sample(1:length(seqs), 1000, replace=FALSE)
seq2 = seqs[sub]
tax_rc = assignTaxonomy(seqs2, "../../silva_nr99_v138.1_train_set.fa.gz", multithread=TRUE, tryRC = TRUE)
write.csv(tax_rc, paste('tax', basename(fastq), 'csv', sep = '.' ))
}

#generate random numbers to subset sequences - 1000 sequences
sub = sample(1:length(seqs), 1000, replace=FALSE)

#read in newly made csv files 
temp = list.files(pattern="*fastq.gz.csv")
for (i in 1:length(temp)) assign(temp[i], read.csv(temp[i]))


#Time for for loop of 5 samples: 
# user   system  elapsed 
#50500.41    69.48  7178.46 

seqs = getSequences('concat_trimmed_1200-1600_singleline.fasta')
tax_rc = assignTaxonomy(seqs, "../../silva_nr99_v138.1_train_set.fa.gz", multithread=TRUE, tryRC = TRUE)


####MERGE MULTIPLE DATA FRAMES?
library(tidyverse)

#put all data frames into list
df_list <- list(df1, df2, df3)

#merge all data frames in list
df_list %>% reduce(full_join, by='variable_name')


#read all data frames into a list?
temp = list.files(pattern="*fastq.gz.csv")
myfiles = lapply(temp, read.csv)


dfList_agg<-lapply(myfiles, function(i) {
  aggregate(i[,1], by=list(i[,3]), FUN=summary)})
